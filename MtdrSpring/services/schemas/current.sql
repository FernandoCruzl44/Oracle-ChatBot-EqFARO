------------------------------------------------------------
--  Reduced schema for schema TODOUSER
------------------------------------------------------------
-- Table: COMMENTS
CREATE TABLE TODOUSER.COMMENTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    TASK_ID NUMBER NOT NULL,
    CONTENT CLOB NOT NULL,
    CREATED_BY_ID NUMBER NOT NULL,
    CREATED_AT TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    CONSTRAINT COMMENTS_PK PRIMARY KEY (ID),
    CONSTRAINT FK_COMMENT_TASK FOREIGN KEY (TASK_ID) REFERENCES TODOUSER.TASKS (ID) ON DELETE CASCADE,
    CONSTRAINT FK_COMMENT_CREATOR FOREIGN KEY (CREATED_BY_ID) REFERENCES TODOUSER.USERS (ID)
);
-- Table: SPRINTS
CREATE TABLE TODOUSER.SPRINTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    TEAM_ID NUMBER NOT NULL,
    START_DATE DATE NOT NULL,
    END_DATE DATE NOT NULL,
    NAME VARCHAR2(100),
    STATUS VARCHAR2(20) DEFAULT 'PLANNED' NOT NULL,
    CONSTRAINT SPRINTS_PK PRIMARY KEY (ID),
    CONSTRAINT CHK_SPRINT_STATUS CHECK (
        STATUS IN ('PLANNED', 'ACTIVE', 'COMPLETED', 'CANCELED')
    ),
    CONSTRAINT FK_SPRINT_TEAM FOREIGN KEY (TEAM_ID) REFERENCES TODOUSER.TEAMS (ID)
);
-- Table: TASKS
CREATE TABLE TODOUSER.TASKS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    TITLE VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    TAG VARCHAR2(50) NOT NULL,
    STATUS VARCHAR2(50) DEFAULT 'Backlog' NOT NULL,
    START_DATE VARCHAR2(50) NOT NULL,
    END_DATE VARCHAR2(50),
    CREATED_BY_ID NUMBER NOT NULL,
    TEAM_ID NUMBER,
    CREATED_AT TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    STORY_POINTS NUMBER,
    PRIORITY VARCHAR2(20),
    SPRINT_ID NUMBER,
    ESTIMATED_HOURS NUMBER(5, 2),
    ACTUAL_HOURS NUMBER(5, 2),
    CONSTRAINT TASKS_PK PRIMARY KEY (ID),
    CONSTRAINT CHK_TASK_STATUS CHECK (
        STATUS IN (
            'Backlog',
            'En progreso',
            'Completada',
            'Cancelada',
            'DONE'
        )
    ),
    CONSTRAINT FK_TASK_CREATOR FOREIGN KEY (CREATED_BY_ID) REFERENCES TODOUSER.USERS (ID),
    CONSTRAINT FK_TASK_TEAM FOREIGN KEY (TEAM_ID) REFERENCES TODOUSER.TEAMS (ID),
    CONSTRAINT FK_TASK_SPRINT FOREIGN KEY (SPRINT_ID) REFERENCES TODOUSER.SPRINTS (ID)
);
-- Table: TASK_ASSIGNEE
CREATE TABLE TODOUSER.TASK_ASSIGNEE (
    TASK_ID NUMBER,
    USER_ID NUMBER,
    CONSTRAINT TASK_ASSIGNEE_PK PRIMARY KEY (TASK_ID, USER_ID),
    CONSTRAINT FK_ASSIGNEE_TASK FOREIGN KEY (TASK_ID) REFERENCES TODOUSER.TASKS (ID) ON DELETE CASCADE,
    CONSTRAINT FK_ASSIGNEE_USER FOREIGN KEY (USER_ID) REFERENCES TODOUSER.USERS (ID)
);
-- Table: TEAMS
CREATE TABLE TODOUSER.TEAMS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR2(255) NOT NULL,
    DESCRIPTION VARCHAR2(2000),
    CREATED_AT TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    CONSTRAINT TEAMS_PK PRIMARY KEY (ID)
);
-- Table: USERS
CREATE TABLE TODOUSER.USERS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(255) NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    ROLE VARCHAR2(20) NOT NULL,
    CREATED_AT TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
    TEAM_ID NUMBER,
    TEAM_ROLE VARCHAR2(50),
    TELEGRAM_USER_ID NUMBER,
    TELEGRAMID VARCHAR2(20),
    CONSTRAINT USERS_PK PRIMARY KEY (ID),
    CONSTRAINT USERS_UK UNIQUE (EMAIL),
    CONSTRAINT FK_USER_TEAM FOREIGN KEY (TEAM_ID) REFERENCES TODOUSER.TEAMS (ID)
);
------------------------------------------------------------
--  Indexes
------------------------------------------------------------
CREATE INDEX IDX_TASK_STORY_POINTS ON TODOUSER.TASKS (STORY_POINTS);
CREATE INDEX IDX_TASK_TEAM ON TODOUSER.TASKS (TEAM_ID);
CREATE INDEX IDX_USER_TEAM ON TODOUSER.USERS (TEAM_ID);
CREATE INDEX IDX_SPRINT_TEAM ON TODOUSER.SPRINTS (TEAM_ID);
CREATE INDEX IDX_USER_TELEGRAM ON TODOUSER.USERS (TELEGRAM_USER_ID);
CREATE INDEX IDX_TASK_CREATOR ON TODOUSER.TASKS (CREATED_BY_ID);
CREATE INDEX IDX_COMMENT_CREATOR ON TODOUSER.COMMENTS (CREATED_BY_ID);
CREATE INDEX IDX_COMMENT_TASK ON TODOUSER.COMMENTS (TASK_ID);
CREATE INDEX IDX_TASK_SPRINT ON TODOUSER.TASKS (SPRINT_ID);